var RecService=function(){var e={},t=function(){this.name="default",this.type="default",this.normalizeReults=function(e){return e.forEach(function(e){e.__optlyMeta__={rec_type:this.type,rec_name:this.name}}),{recs:e,name:this.name}}.bind(this)},n=function(e,n){t.call(this),this.name="custom_datasource_"+n,this.type="custom_datasource",this.run=function(){return e().then(this.normalizeReults)}},r=function(n,r){t.call(this),this.name=r.name||r.id,this.type=r.type;var i=function(){switch(r.type){case"popular":return"popular";case"cobrowse":return r.target;case"user":return e.visitor.visitorId}};this.run=function(){return e.recommender.getRecommendationsFetcher(n,i(),{preFilter:r.prefilter,canonicalize:r.canonicalize,postFilter:r.postfilter}).next(r.max||10).then(this.normalizeReults)}},i=function(e){var t=e.log?console:{log:function(){},group:function(){},groupEnd:function(){},groupCollapsed:function(){},dir:function(){}};this.logger=t,this.recommenders=[],this.datasources=[],this.addRecommender=function(t){return t.prefilter=t.prefilter||e.prefilter,t.postfilter=t.postfilter||e.postfilter,t.canonicalize=t.canonicalize||e.canonicalize,this.recommenders.push(new r({recommenderServiceId:e.serviceId,recommenderId:t.id},t)),this},this.addDatasource=function(e){return this.datasources.push(new n(e,this.datasources.length+1)),this},this.execAll=function(){var e=this.recommenders.map(function(e){return e.run()}),t=this.datasources.map(function(e){return e.run()}),n=e.concat(t);return Promise.all(n)},this.run=function(){var n={};return this.execAll().then(function(r){if(t.groupCollapsed("RECOMMENDATIONS"),r.forEach(function(e){n[e.name]=e.recs}),e.log)for(var i in n)t.groupCollapsed('Recommender "'+i+'" ('+n[i].length+")"),t.dir(n[i]),t.groupEnd();return t.log("[Run] ",n),t.groupEnd(),n})},this.merge=function(e){e=e||{};var n=[];return this.execAll().then(function(r){return t.groupCollapsed("RECOMMENDATIONS"),r.forEach(function(e){t.groupCollapsed('Recommender "'+e.name+'" ('+e.recs.length+") "),t.dir(e.recs),t.groupEnd(),n=n.concat(e.recs.map(function(e){return e}))}),e.max&&(n=n.slice(0,e.max)),t.log("[Merged] ",n),t.groupEnd(),n})}};return{init:function(t){return e.recommender=e.recommender||optimizely.get("recommender"),e.visitor=e.visitor||optimizely.get("visitor"),new i(t)}}}();